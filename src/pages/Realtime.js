import React from "react";
import mapboxgl from "mapbox-gl";
import socketIOClient from "socket.io-client";

const mapStyle = {
  position: "absolute",
  top: 0,
  right: 0,
  left: 0,
  bottom: 0
};

mapboxgl.accessToken =
  "pk.eyJ1IjoicmVuZWVsaW4iLCJhIjoiY2s2bGdsM294MGFyNDNkcGZxdjRiamVtZCJ9.NXBRh4xFGeNFfqikqH97bA";

class Realtime extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      response: {
        geometry: {
          type: "Point",
          coordinates: [151.236197636045, -33.8793459155006]
        },
        type: "Feature",
        properties: {}
      },
      // lng: 153.0137,
      // lat: -27.4975,
      lng: 36.19583044471166,
      lat: 44.17716381518971,
      zoom: 13,
      endpoint: "http://localhost:4000"
    };
  }

  componentDidMount() {
    const { endpoint } = this.state;
    const socket = socketIOClient(endpoint);
    socket.on("post", data => {
      // console.log(data);
      this.setState({ response: data });
    });
    fetch(endpoint).then(data => console.log(data));
    var map = (window.map = new mapboxgl.Map({
      container: this.mapContainer,
      style: "mapbox://styles/mapbox/streets-v11",
      zoom: 13,
      center: [this.state.lng, this.state.lat],
      pitch: 60,
      antialias: true // create the gl context with MSAA antialiasing, so custom layers are antialiased
    }));
    var that = this;
    var map = (window.map = new mapboxgl.Map({
      container: this.mapContainer,
      style: "mapbox://styles/mapbox/dark-v9",
      zoom: this.state.zoom,
      // center: [this.state.lng, this.state.lat],
      center: [151.236197636045, -33.8793459155006],
      pitch: 60,
      antialias: true // create the gl context with MSAA antialiasing, so custom layers are antialiased
    }));

    // var url = "https://wanderdrone.appspot.com/";
    map.on("load", function() {
      window.setInterval(function() {
        map.getSource("drone").setData(that.state.response);
      }, 2000);

      map.addSource("route", {
        type: "geojson",
        data: {
          type: "Feature",
          properties: {},
          geometry: {
            type: "LineString",
            coordinates: [
              [151.236197636045, -33.8793459155006],
              [151.236270102223, -33.8790641186614],
              [151.236618742602, -33.8791241886502],
              [151.236698681636, -33.879211532399],
              [151.236621667563, -33.8796196220385],
              [151.236648133632, -33.8797178172816],
              [151.236769872393, -33.8797766920859],
              [151.237172434791, -33.879834903025],
              [151.237313514598, -33.8798480624656],
              [151.237550312095, -33.8798308950938],
              [151.237524829558, -33.8795344526469],
              [151.237428315457, -33.879330554293],
              [151.237346594044, -33.8792072336254],
              [151.237090107239, -33.8790448845777],
              [151.235102992177, -33.8786177837016],
              [151.234823608418, -33.878429188827],
              [151.234458058943, -33.8780273262124],
              [151.233884065767, -33.8775605593464],
              [151.233884065767, -33.8775605593464],
              [151.233636148704, -33.8773528589532],
              [151.233336095153, -33.8771829912138],
              [151.23322603561, -33.8771417302505],
              [151.232417380868, -33.8769533233366],
              [151.231601058918, -33.8768282428308],
              [151.231871199296, -33.8766117255702],
              [151.232023610356, -33.8764172776682],
              [151.232128884072, -33.8761433637671],
              [151.232146111307, -33.8758364401252],
              [151.232256276855, -33.875661464913],
              [151.232328646432, -33.8755959068357],
              [151.232423916928, -33.8755565899681],
              [151.232786100511, -33.8754540304707],
              [151.233182073544, -33.8751611028235],
              [151.233182073544, -33.8751611028235],
              [151.233702102972, -33.874755787674],
              [151.233897639382, -33.8745598534727],
              [151.233897639382, -33.8745598534727],
              [151.234742694368, -33.8737379093528],
              [151.235502015787, -33.8727116883556],
              [151.235502015787, -33.8727116883556],
              [151.235663859671, -33.8724898825596],
              [151.236137467334, -33.8713653790263],
              [151.23617036014, -33.8711570228153],
              [151.236170459708, -33.8709407861301],
              [151.236170459708, -33.8709407861301],
              [151.236167888594, -33.8706705830914],
              [151.236100522098, -33.8706188445321],
              [151.236097851411, -33.8705648781783],
              [151.236149538916, -33.8705180497342],
              [151.23623624495, -33.8705240737051],
              [151.236287042087, -33.8704592564297],
              [151.236226551843, -33.8701099604073],
              [151.236311330533, -33.869422302329],
              [151.236382356606, -33.8693297592817],
              [151.236874441374, -33.8690154920678],
              [151.236874441374, -33.8690154920678],
              [151.237115313768, -33.8688630406959],
              [151.237275714006, -33.8688304869364],
              [151.238186332088, -33.8688982256865],
              [151.238963999231, -33.8688984611144],
              [151.238963999231, -33.8688984611144],
              [151.239158527285, -33.8689007677915],
              [151.239132601229, -33.868595331114],
              [151.240144267234, -33.8687406606715],
              [151.240243000452, -33.8689895292952],
              [151.240243000452, -33.8689895292952],
              [151.24031571419, -33.8691491976418],
              [151.240007209198, -33.8698986265379],
              [151.239718664147, -33.8701788623465],
              [151.239538833774, -33.8704733704182],
              [151.239358910698, -33.8709841143865],
              [151.238477945907, -33.8708613054199],
              [151.238477945907, -33.8708613054199],
              [151.238216936153, -33.8708252494511],
              [151.23787170157, -33.8712696091271],
              [151.237806019509, -33.8714700854695],
              [151.237790593106, -33.8718129859271],
              [151.237972535973, -33.8728698638516],
              [151.237972535973, -33.8728698638516],
              [151.237986436315, -33.8729324529389],
              [151.237897851805, -33.8731066892332],
              [151.237701882902, -33.8732936345151],
              [151.237114512814, -33.8736472267931],
              [151.236607168945, -33.8738719243253],
              [151.236257017795, -33.8742173426589],
              [151.236257017795, -33.8742173426589],
              [151.236178321304, -33.8743732179404],
              [151.236256028961, -33.8744155904744],
              [151.23628204715, -33.8745047916272],
              [151.236210126888, -33.8745793461265],
              [151.236135090201, -33.8745909398905],
              [151.236075981308, -33.8751425681296],
              [151.235957267189, -33.8753628893954],
              [151.235729384465, -33.8755599405736],
              [151.235486266048, -33.8756674187767],
              [151.235486266048, -33.8756674187767],
              [151.235159106188, -33.8758228386509],
              [151.235060175114, -33.8760064391678],
              [151.234842869044, -33.8766355913247],
              [151.234788647741, -33.8772861579308],
              [151.235067725938, -33.878123463379],
              [151.235067725938, -33.878123463379],
              [151.235119763061, -33.8783018661168],
              [151.23510843409, -33.8785094797097],
              [151.235262966221, -33.8785762367614],
              [151.237607723329, -33.8790270532778],
              [151.237599424811, -33.8795138633612],
              [151.237636136784, -33.8798189286175],
              [151.237313514598, -33.8798480624656],
              [151.236769872393, -33.8797766920859],
              [151.236423901052, -33.8797705889935],
              [151.236216782909, -33.8797326737547],
              [151.236363050989, -33.8791960631534]
            ]
          }
        }
      });

      map.addLayer({
        id: "route",
        type: "line",
        source: "route",
        layout: {
          "line-join": "round",
          "line-cap": "round"
        },
        paint: {
          "line-color": "#FF4500",
          "line-width": 8
        }
      });

      map.addSource("drone", { type: "geojson", data: that.state.response });
      map.addLayer({
        id: "drone",
        type: "symbol",
        source: "drone",
        layout: {
          "icon-image": "bus-15"
        },
        paint: {
          // "icon-color": "#0000ff"
          // "fill-color": "#0000ff"
        }
      });
    });
  }

  render() {
    return (
      <div>
        <div ref={el => (this.mapContainer = el)} style={mapStyle} />
      </div>
    );
  }
}

export default Realtime;
